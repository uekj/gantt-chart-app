# ドラッグ&ドロップ順序変更機能 設計書

**作成日**: 2025-01-19  
**ステータス**: 設計中

## 概要

プロジェクトとタスクの表示順序をドラッグ&ドロップで変更できる機能の設計書。

## 現状分析

### 既存実装状況
- **API**: `display_order`フィールドを使った順序管理は実装済み
  - `PUT /api/projects/[id]` - プロジェクトの`display_order`更新対応
  - `PUT /api/tasks/[id]` - タスクの`display_order`更新対応
- **データベース**: `display_order`カラムは`projects`と`tasks`テーブルに存在
- **フロントエンド**: ドラッグ&ドロップによる順序変更UI未実装

### 既存のドラッグ&ドロップ機能
現在実装済み:
- タスクの日程移動（ガントチャート上での水平ドラッグ）
- タスクの期間調整（リサイズ）

## 設計方針

### 1. UI設計

#### プロジェクト順序変更
- **場所**: サイドバーのプロジェクト一覧
- **操作**: プロジェクト項目を上下にドラッグして順序変更
- **視覚フィードバック**: ドラッグ中のドロップゾーン表示

#### タスク順序変更
- **場所**: サイドバーのタスク一覧（各プロジェクト内）
- **操作**: タスク項目を上下にドラッグして順序変更
- **制約**: 同一プロジェクト内でのみ順序変更可能

### 2. 技術実装

#### ドラッグ&ドロップライブラリ
- **選択肢1**: `@dnd-kit/core` + `@dnd-kit/sortable`
- **選択肢2**: `react-beautiful-dnd`
- **推奨**: `@dnd-kit/core` (React 18対応、アクセシビリティ対応、軽量)

#### 順序値の計算方式
- **方式**: Gap方式（間隔を空けた順序値）
- **初期値**: 1000, 2000, 3000... (1000間隔)
- **挿入時**: 前後の値の中間値を計算
- **例**: 1000と3000の間に挿入 → 2000

#### API呼び出し
- 順序変更時は既存のPUT APIを使用
- バッチ更新は行わず、変更された項目のみ更新

### 3. データフローと状態同期

#### 状態不整合の解消タイミング

```
1. ドラッグ開始
   - フロントエンド: 一時的な順序状態を作成
   - バックエンド: 変更なし
   - 状態: 不整合開始 ⚠️

2. ドラッグ中 
   - フロントエンド: 表示順序リアルタイム更新
   - バックエンド: 変更なし
   - 状態: 不整合継続 ⚠️

3. ドロップ完了
   - フロントエンド: 新しい順序で表示継続
   - バックエンド: API呼び出し開始
   - 状態: 楽観的更新実行中 🔄

4. API成功時
   - フロントエンド: 状態維持
   - バックエンド: DB更新完了
   - 状態: 整合性回復 ✅

5. API失敗時
   - フロントエンド: 元の位置にロールバック
   - バックエンド: 元の状態維持
   - 状態: 整合性回復 ✅
```

#### 状態不整合の許容時間
- **通常**: 1-2秒（API応答時間）
- **ネットワーク遅延時**: 最大5秒
- **タイムアウト**: 10秒後に失敗扱い

#### エラー復旧戦略
1. **ロールバック方式**（推奨）: 元の位置に戻す
2. **リフレッシュ方式**: 最新データを再取得
3. **ユーザー通知**: エラートースト表示

## 実装計画

### Phase 1: ライブラリ導入
- [ ] `@dnd-kit/core`、`@dnd-kit/sortable`インストール
- [ ] 基本的なドラッグ&ドロップコンポーネント作成

### Phase 2: プロジェクト順序変更
- [ ] サイドバーでプロジェクト順序変更UI実装
- [ ] 順序値計算ロジック実装
- [ ] API連携実装

### Phase 3: タスク順序変更
- [ ] サイドバーでタスク順序変更UI実装
- [ ] 同一プロジェクト内制約の実装
- [ ] API連携実装

### Phase 4: エラーハンドリング・最適化
- [ ] ネットワークエラー時の復旧処理
- [ ] 楽観的更新の実装
- [ ] パフォーマンス最適化

## 技術検討事項

### 順序値の管理方式
- **Gap方式**: 間隔を空けた整数値（採用予定）
- **メリット**: 挿入時の計算が簡単、データベース負荷が少ない
- **デメリット**: 頻繁な操作で値が収束する可能性

### エラーハンドリング
- **楽観的更新**: UI先行更新 + API失敗時のロールバック
- **悲観的更新**: API成功後にUI更新（UX劣化）
- **採用**: 楽観的更新（UX重視）

### パフォーマンス考慮
- **デバウンス**: 連続操作時のAPI呼び出し制限
- **バッチ処理**: 複数項目の同時更新（将来検討）

## UI/UXガイドライン

### ドラッグ時の視覚フィードバック
- ドラッグ中の項目: 透明度50%
- ドロップゾーン: 青いハイライト線
- ドラッグ不可エリア: 赤いXアイコン

### アクセシビリティ
- キーボード操作対応（矢印キー + Enter）
- スクリーンリーダー対応
- フォーカス管理

## リスク・課題

### 技術リスク
- ライブラリ依存による保守性の懸念
- タッチデバイスでの操作性
- 大量データでのパフォーマンス

### UX課題
- 既存のガントチャートドラッグとの操作競合
- 誤操作による意図しない順序変更

## 次のアクション

1. `@dnd-kit`ライブラリのプロトタイプ作成
2. サイドバーコンポーネントの順序変更UI実装
3. 順序値計算ロジックのユニットテスト作成